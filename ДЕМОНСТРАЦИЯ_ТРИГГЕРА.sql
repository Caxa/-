-- ============================================================================
-- ДЕМОНСТРАЦИЯ РАБОТЫ ТРИГГЕРА ОБНОВЛЕНИЯ СТАТУСА ТУРНИРА
-- ============================================================================
-- Этот скрипт демонстрирует работу триггера, который автоматически
-- обновляет статус турнира при изменении даты начала или окончания
-- ============================================================================

-- ШАГ 1: Просмотр состояния ДО обновления
-- Выбираем турнир для демонстрации (например, первый турнир)
SELECT 
    '=== СОСТОЯНИЕ ДО ОБНОВЛЕНИЯ ===' as этап;

SELECT 
    t.id,
    t.название,
    t.дата_начала,
    t.дата_окончания,
    ts.код as статус_код,
    ts.название as статус_название,
    CURRENT_DATE as текущая_дата
FROM турниры t
JOIN статусы_турниров ts ON t.ид_статуса = ts.id
WHERE t.id = 1;

-- ШАГ 2: Обновление даты начала турнира на текущую дату
-- Это должно автоматически изменить статус с "Предстоящий" на "Активный"
SELECT 
    '=== ОБНОВЛЕНИЕ ДАТЫ НАЧАЛА НА ТЕКУЩУЮ ДАТУ ===' as этап;

UPDATE турниры 
SET дата_начала = CURRENT_DATE
WHERE id = 1;

-- ШАГ 3: Просмотр состояния ПОСЛЕ обновления
-- Триггер должен автоматически обновить статус
SELECT 
    '=== СОСТОЯНИЕ ПОСЛЕ ОБНОВЛЕНИЯ ===' as этап;

SELECT 
    t.id,
    t.название,
    t.дата_начала,
    t.дата_окончания,
    ts.код as статус_код,
    ts.название as статус_название,
    CURRENT_DATE as текущая_дата
FROM турниры t
JOIN статусы_турниров ts ON t.ид_статуса = ts.id
WHERE t.id = 1;

-- ШАГ 4: Демонстрация изменения статуса на "Завершен"
-- Обновляем дату окончания на прошедшую дату
SELECT 
    '=== ОБНОВЛЕНИЕ ДАТЫ ОКОНЧАНИЯ НА ПРОШЕДШУЮ ДАТУ ===' as этап;

UPDATE турниры 
SET дата_окончания = CURRENT_DATE - INTERVAL '1 day'
WHERE id = 1;

-- ШАГ 5: Просмотр состояния после установки прошедшей даты окончания
SELECT 
    '=== СОСТОЯНИЕ ПОСЛЕ УСТАНОВКИ ПРОШЕДШЕЙ ДАТЫ ОКОНЧАНИЯ ===' as этап;

SELECT 
    t.id,
    t.название,
    t.дата_начала,
    t.дата_окончания,
    ts.код as статус_код,
    ts.название as статус_название,
    CURRENT_DATE as текущая_дата
FROM турниры t
JOIN статусы_турниров ts ON t.ид_статуса = ts.id
WHERE t.id = 1;

-- ШАГ 6: Демонстрация возврата статуса на "Предстоящий"
-- Устанавливаем дату начала в будущее
SELECT 
    '=== УСТАНОВКА ДАТЫ НАЧАЛА В БУДУЩЕЕ ===' as этап;

UPDATE турниры 
SET 
    дата_начала = CURRENT_DATE + INTERVAL '10 days',
    дата_окончания = NULL
WHERE id = 1;

-- ШАГ 7: Финальное состояние
SELECT 
    '=== ФИНАЛЬНОЕ СОСТОЯНИЕ (СТАТУС "ПРЕДСТОЯЩИЙ") ===' as этап;

SELECT 
    t.id,
    t.название,
    t.дата_начала,
    t.дата_окончания,
    ts.код as статус_код,
    ts.название as статус_название,
    CURRENT_DATE as текущая_дата
FROM турниры t
JOIN статусы_турниров ts ON t.ид_статуса = ts.id
WHERE t.id = 1;

-- ============================================================================
-- АЛЬТЕРНАТИВНЫЙ ВАРИАНТ: Демонстрация с несколькими турнирами
-- ============================================================================

-- Показываем все турниры с их статусами
SELECT 
    '=== ВСЕ ТУРНИРЫ С ТЕКУЩИМИ СТАТУСАМИ ===' as этап;

SELECT 
    t.id,
    t.название,
    t.дата_начала,
    t.дата_окончания,
    ts.код as статус_код,
    ts.название as статус_название,
    CASE 
        WHEN t.дата_окончания IS NOT NULL AND t.дата_окончания < CURRENT_DATE THEN 'Завершен'
        WHEN t.дата_начала <= CURRENT_DATE AND (t.дата_окончания IS NULL OR t.дата_окончания >= CURRENT_DATE) THEN 'Активный'
        ELSE 'Предстоящий'
    END as ожидаемый_статус,
    CASE 
        WHEN ts.код = CASE 
            WHEN t.дата_окончания IS NOT NULL AND t.дата_окончания < CURRENT_DATE THEN 'completed'
            WHEN t.дата_начала <= CURRENT_DATE AND (t.дата_окончания IS NULL OR t.дата_окончания >= CURRENT_DATE) THEN 'active'
            ELSE 'upcoming'
        END THEN '✓ Триггер работает'
        ELSE '✗ Ошибка триггера'
    END as проверка
FROM турниры t
JOIN статусы_турниров ts ON t.ид_статуса = ts.id
ORDER BY t.id;

