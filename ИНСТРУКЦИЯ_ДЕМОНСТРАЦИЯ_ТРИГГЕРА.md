# Инструкция по демонстрации работы триггера обновления статуса турнира

## Описание триггера

Триггер `триггер_обновить_статус_турнира` автоматически обновляет статус турнира при изменении даты начала или даты окончания. Триггер срабатывает **ПЕРЕД** вставкой или обновлением записи (BEFORE INSERT OR UPDATE).

### Логика работы триггера:

1. **"Предстоящий" (upcoming)** — если дата начала в будущем
2. **"Активный" (active)** — если текущая дата между датой начала и окончания (или окончание не установлено)
3. **"Завершен" (completed)** — если дата окончания в прошлом

## Способы демонстрации

### Способ 1: Использование SQL-скрипта (pgAdmin или psql)

1. Откройте файл `ДЕМОНСТРАЦИЯ_ТРИГГЕРА.sql` в pgAdmin или выполните его через psql
2. Скрипт покажет состояние ДО и ПОСЛЕ каждого обновления
3. Сделайте скриншоты результатов каждого SELECT-запроса

### Способ 2: Пошаговая демонстрация вручную

#### Шаг 1: Просмотр состояния ДО обновления

```sql
-- Выбираем турнир для демонстрации
SELECT 
    t.id,
    t.название,
    t.дата_начала,
    t.дата_окончания,
    ts.код as статус_код,
    ts.название as статус_название,
    CURRENT_DATE as текущая_дата
FROM турниры t
JOIN статусы_турниров ts ON t.ид_статуса = ts.id
WHERE t.id = 1;
```

**Сделайте скриншот** — это будет состояние "ДО"

#### Шаг 2: Обновление даты начала

```sql
-- Обновляем дату начала на текущую дату
UPDATE турниры 
SET дата_начала = CURRENT_DATE
WHERE id = 1;
```

#### Шаг 3: Просмотр состояния ПОСЛЕ обновления

```sql
-- Проверяем, что статус автоматически изменился
SELECT 
    t.id,
    t.название,
    t.дата_начала,
    t.дата_окончания,
    ts.код as статус_код,
    ts.название as статус_название,
    CURRENT_DATE as текущая_дата
FROM турниры t
JOIN статусы_турниров ts ON t.ид_статуса = ts.id
WHERE t.id = 1;
```

**Сделайте скриншот** — это будет состояние "ПОСЛЕ"

Вы увидите, что статус автоматически изменился с "Предстоящий" на "Активный" без явного обновления поля `ид_статуса`.

### Способ 3: Демонстрация через веб-интерфейс

1. Откройте страницу "Турниры" в веб-приложении
2. Найдите турнир со статусом "Предстоящий"
3. Отредактируйте турнир и измените дату начала на текущую дату
4. Сохраните изменения
5. Обновите страницу — статус должен автоматически измениться на "Активный"

**Сделайте скриншоты:**
- Страница ДО редактирования (статус "Предстоящий")
- Форма редактирования с новой датой
- Страница ПОСЛЕ сохранения (статус "Активный")

## Примеры сценариев для демонстрации

### Сценарий 1: Изменение статуса с "Предстоящий" на "Активный"

```sql
-- ДО: Турнир с датой начала в будущем
UPDATE турниры SET дата_начала = '2025-12-25' WHERE id = 1;
SELECT t.название, t.дата_начала, ts.название as статус 
FROM турниры t JOIN статусы_турниров ts ON t.ид_статуса = ts.id WHERE t.id = 1;

-- Обновление даты на текущую
UPDATE турниры SET дата_начала = CURRENT_DATE WHERE id = 1;

-- ПОСЛЕ: Статус автоматически изменился
SELECT t.название, t.дата_начала, ts.название as статус 
FROM турниры t JOIN статусы_турниров ts ON t.ид_статуса = ts.id WHERE t.id = 1;
```

### Сценарий 2: Изменение статуса на "Завершен"

```sql
-- ДО: Активный турнир
UPDATE турниры SET дата_начала = CURRENT_DATE - INTERVAL '5 days', дата_окончания = CURRENT_DATE + INTERVAL '5 days' WHERE id = 1;
SELECT t.название, t.дата_окончания, ts.название as статус 
FROM турниры t JOIN статусы_турниров ts ON t.ид_статуса = ts.id WHERE t.id = 1;

-- Обновление даты окончания на прошедшую
UPDATE турниры SET дата_окончания = CURRENT_DATE - INTERVAL '1 day' WHERE id = 1;

-- ПОСЛЕ: Статус автоматически изменился на "Завершен"
SELECT t.название, t.дата_окончания, ts.название as статус 
FROM турниры t JOIN статусы_турниров ts ON t.ид_статуса = ts.id WHERE t.id = 1;
```

## Что показать на скриншотах

Для отчета вам понадобятся скриншоты, показывающие:

1. **Скриншот 1 (ДО):**
   - Запрос SELECT с текущим состоянием турнира
   - Видно: дата начала в будущем, статус "Предстоящий"

2. **Скриншот 2 (ПОСЛЕ):**
   - Запрос UPDATE (или форма редактирования)
   - Видно: изменение даты начала на текущую дату

3. **Скриншот 3 (РЕЗУЛЬТАТ):**
   - Запрос SELECT с новым состоянием
   - Видно: дата начала = текущая дата, статус автоматически изменился на "Активный"

## Проверка работы триггера

Чтобы убедиться, что триггер работает правильно, выполните:

```sql
-- Проверяем, что все турниры имеют корректные статусы
SELECT 
    t.id,
    t.название,
    t.дата_начала,
    t.дата_окончания,
    ts.название as текущий_статус,
    CASE 
        WHEN t.дата_окончания IS NOT NULL AND t.дата_окончания < CURRENT_DATE THEN 'Завершен'
        WHEN t.дата_начала <= CURRENT_DATE AND (t.дата_окончания IS NULL OR t.дата_окончания >= CURRENT_DATE) THEN 'Активный'
        ELSE 'Предстоящий'
    END as ожидаемый_статус,
    CASE 
        WHEN ts.код = CASE 
            WHEN t.дата_окончания IS NOT NULL AND t.дата_окончания < CURRENT_DATE THEN 'completed'
            WHEN t.дата_начала <= CURRENT_DATE AND (t.дата_окончания IS NULL OR t.дата_окончания >= CURRENT_DATE) THEN 'active'
            ELSE 'upcoming'
        END THEN '✓'
        ELSE '✗'
    END as проверка
FROM турниры t
JOIN статусы_турниров ts ON t.ид_статуса = ts.id;
```

Все записи должны иметь "✓" в колонке "проверка".

