# Инструкция по миграции базы данных на нормализованную структуру

## Что было изменено

1. **Все кириллические имена заменены на английские:**
   - Таблицы: `участники` → `participants`, `жюри` → `judges`, `темы` → `topics`, `сезоны` → `seasons`, `турниры` → `tournaments`, `раунды` → `rounds`, `выступления` → `performances`
   - Поля: `ид` → `id`, `имя` → `first_name`, `фамилия` → `last_name`, `электронная_почта` → `email`, `дата_создания` → `created_at`, и т.д.

2. **Добавлены справочные таблицы для нормализации:**
   - `tournament_statuses` - для статусов турниров (вместо хранения строк)
   - `debate_positions` - для позиций в дебатах (вместо хранения строк 'За'/'Против')

3. **Обновлена структура таблиц:**
   - `tournaments.status` → `tournaments.status_id` (FK на `tournament_statuses`)
   - `performances.position` → `performances.position_id` (FK на `debate_positions`)

4. **Обновлены все SQL-запросы, модели Go и шаблоны HTML**

## Порядок миграции

### Вариант 1: Полное пересоздание базы данных (рекомендуется для новой установки)

1. **Создайте резервную копию существующих данных (если нужно):**
   ```bash
   pg_dump -U postgres -d debate_club > backup_before_migration.sql
   ```

2. **Выполните скрипт пересоздания:**
   ```bash
   psql -U postgres -d debate_club -f recreate_database_normalized.sql
   ```

   Или по частям:
   ```bash
   psql -U postgres -d debate_club -f schema_normalized.sql
   psql -U postgres -d debate_club -f seed_normalized.sql
   ```

3. **Проверьте создание таблиц:**
   ```sql
   SELECT table_name FROM information_schema.tables 
   WHERE table_schema = 'public' 
   ORDER BY table_name;
   ```

### Вариант 2: Миграция данных из старой структуры

Если у вас есть важные данные в старой базе, создайте скрипт миграции:

```sql
-- 1. Создайте новые справочные таблицы
INSERT INTO tournament_statuses (code, name, description) VALUES
    ('upcoming', 'Предстоящий', 'Турнир еще не начался'),
    ('active', 'Активный', 'Турнир проходит в данный момент'),
    ('completed', 'Завершен', 'Турнир завершен');

INSERT INTO debate_positions (code, name, description) VALUES
    ('for', 'За', 'Позиция "За" в дебатах'),
    ('against', 'Против', 'Позиция "Против" в дебатах');

-- 2. Мигрируйте данные из старых таблиц в новые
-- (пример для участников)
INSERT INTO participants (id, first_name, last_name, email, created_at)
SELECT ид, имя, фамилия, электронная_почта, дата_создания
FROM участники;

-- 3. Мигрируйте турниры с конвертацией статуса
INSERT INTO tournaments (id, season_id, name, start_date, end_date, status_id, created_at)
SELECT 
    т.ид,
    т.ид_сезона,
    т.название,
    т.дата_начала,
    т.дата_окончания,
    CASE т.статус
        WHEN 'предстоящий' THEN (SELECT id FROM tournament_statuses WHERE code = 'upcoming')
        WHEN 'активный' THEN (SELECT id FROM tournament_statuses WHERE code = 'active')
        WHEN 'завершен' THEN (SELECT id FROM tournament_statuses WHERE code = 'completed')
        ELSE (SELECT id FROM tournament_statuses WHERE code = 'upcoming')
    END,
    т.дата_создания
FROM турниры т;

-- 4. Мигрируйте выступления с конвертацией позиции
INSERT INTO performances (id, round_id, participant_id, position_id, logic_score, rhetoric_score, erudition_score, judge_id, created_at)
SELECT 
    в.ид,
    в.ид_раунда,
    в.ид_участника,
    CASE в.позиция
        WHEN 'За' THEN (SELECT id FROM debate_positions WHERE code = 'for')
        WHEN 'Против' THEN (SELECT id FROM debate_positions WHERE code = 'against')
        ELSE (SELECT id FROM debate_positions WHERE code = 'for')
    END,
    в.оценка_логики,
    в.оценка_риторики,
    в.оценка_эрудиции,
    в.ид_судьи,
    в.дата_создания
FROM выступления в;

-- 5. После миграции удалите старые таблицы
DROP TABLE IF EXISTS выступления CASCADE;
DROP TABLE IF EXISTS раунды CASCADE;
DROP TABLE IF EXISTS турниры CASCADE;
DROP TABLE IF EXISTS сезоны CASCADE;
DROP TABLE IF EXISTS темы CASCADE;
DROP TABLE IF EXISTS участники CASCADE;
DROP TABLE IF EXISTS жюри CASCADE;
DROP TABLE IF EXISTS аудит_участников CASCADE;
```

## Проверка после миграции

1. **Проверьте количество записей:**
   ```sql
   SELECT 
       'participants' as table_name, COUNT(*) as count FROM participants
   UNION ALL
   SELECT 'judges', COUNT(*) FROM judges
   UNION ALL
   SELECT 'topics', COUNT(*) FROM topics
   UNION ALL
   SELECT 'seasons', COUNT(*) FROM seasons
   UNION ALL
   SELECT 'tournaments', COUNT(*) FROM tournaments
   UNION ALL
   SELECT 'rounds', COUNT(*) FROM rounds
   UNION ALL
   SELECT 'performances', COUNT(*) FROM performances;
   ```

2. **Проверьте внешние ключи:**
   ```sql
   SELECT * FROM tournaments WHERE status_id NOT IN (SELECT id FROM tournament_statuses);
   SELECT * FROM performances WHERE position_id NOT IN (SELECT id FROM debate_positions);
   ```

3. **Проверьте работу приложения:**
   - Запустите приложение: `go run .`
   - Откройте в браузере и проверьте все разделы
   - Убедитесь, что статусы и позиции отображаются правильно

## Откат изменений (если что-то пошло не так)

Если нужно вернуться к старой структуре:

1. Восстановите из резервной копии:
   ```bash
   psql -U postgres -d debate_club < backup_before_migration.sql
   ```

2. Или восстановите старые версии файлов из git (если используете)

## Важные замечания

1. **Все SQL-запросы обновлены** - теперь используют английские имена таблиц и полей
2. **Модели Go обновлены** - добавлены структуры `TournamentStatus` и `DebatePosition`
3. **Handlers обновлены** - работают с новой структурой, конвертируют 'За'/'Против' в 'for'/'against'
4. **Шаблоны HTML обновлены** - используют `.Status.Name` и `.Position.Name` вместо строк
5. **Триггеры обновлены** - автоматически обновляют статусы турниров на основе дат

## Преимущества новой структуры

1. **Нормализация до BCNF** - статусы и позиции вынесены в отдельные таблицы
2. **Целостность данных** - внешние ключи гарантируют корректность значений
3. **Легкость расширения** - можно легко добавить новые статусы или позиции
4. **Английские имена** - соответствуют стандартам именования в БД
5. **Улучшенная производительность** - индексы на справочных таблицах

