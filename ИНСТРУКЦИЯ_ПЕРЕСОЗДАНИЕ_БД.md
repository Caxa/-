# Инструкция по пересозданию базы данных

## Способ 1: Использование готового скрипта (рекомендуется)

### Через psql (командная строка)

```bash
# Подключитесь к PostgreSQL и выполните скрипт
psql -U postgres -d debate_club -f recreate_database_normalized.sql
```

Или если база данных еще не создана:

```bash
# Создайте базу данных (если еще не создана)
createdb -U postgres debate_club

# Выполните скрипт пересоздания
psql -U postgres -d debate_club -f recreate_database_normalized.sql
```

### Через pgAdmin

1. Откройте pgAdmin
2. Подключитесь к серверу PostgreSQL
3. Правой кнопкой мыши на базе данных `debate_club` → **Query Tool**
4. Откройте файл `recreate_database_normalized.sql`
5. Нажмите **Execute** (F5) или кнопку ▶️

## Способ 2: Выполнение schema_normalized.sql вручную

Если хотите выполнить только схему без тестовых данных:

```bash
psql -U postgres -d debate_club -f schema_normalized.sql
```

Затем при необходимости заполните тестовыми данными:

```bash
psql -U postgres -d debate_club -f seed_normalized.sql
```

## Что делает скрипт recreate_database_normalized.sql

1. **Удаляет старые объекты:**
   - Все таблицы (старые и новые)
   - Все функции (включая новые для регистрации)
   - Все последовательности

2. **Создает новую структуру:**
   - Выполняет `schema_normalized.sql`, который создает:
     - Все таблицы (включая `регистрации_на_турнир`)
     - Все функции (включая функции для регистрации и перераспределения)
     - Все триггеры (включая триггеры для автоматической проверки)

3. **Заполняет тестовыми данными:**
   - Выполняет `seed_normalized.sql` с тестовыми данными

## Важно!

⚠️ **ВНИМАНИЕ:** Пересоздание базы данных **удалит все существующие данные**!

Если у вас есть важные данные, сделайте резервную копию:

```bash
# Создание резервной копии
pg_dump -U postgres debate_club > backup_$(date +%Y%m%d_%H%M%S).sql

# Восстановление из резервной копии (если нужно)
psql -U postgres debate_club < backup_YYYYMMDD_HHMMSS.sql
```

## Проверка успешного создания

После выполнения скрипта вы должны увидеть:

```
База данных успешно пересоздана!
участники | жюри | темы | сезоны | турниры | раунды | выступления | статусы | позиции | регистрации
----------+------+------+--------+---------+--------+------------+---------+---------+-------------
    ...   | ...  | ...  |  ...   |   ...   |  ...   |    ...     |   ...   |   ...   |     ...
```

## Новые функции и триггеры

После пересоздания базы данных будут доступны:

### Функции:
- `перераспределить_участников_турнира(ид_турнира)` - перераспределяет участников между командами
- `проверить_и_перенести_турнир(ид_турнира)` - проверяет количество участников и переносит турнир
- `обработать_турниры_в_день_начала()` - обрабатывает все турниры, которые начинаются сегодня или завтра

### Триггеры:
- `триггер_проверить_турнир_при_регистрации` - автоматически проверяет турнир при регистрации участника
- `триггер_проверить_турнир_при_изменении_даты` - автоматически проверяет турнир при изменении даты

## Устранение проблем

### Ошибка: "database does not exist"
```bash
createdb -U postgres debate_club
```

### Ошибка: "permission denied"
Убедитесь, что у пользователя есть права на создание/удаление объектов:
```sql
GRANT ALL PRIVILEGES ON DATABASE debate_club TO your_username;
```

### Ошибка: "relation already exists"
Это нормально - скрипт сначала удаляет все объекты, затем создает заново. Если ошибка повторяется, выполните скрипт еще раз.
